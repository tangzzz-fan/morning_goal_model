## 文档补充计划

* 技术文档新增章节：

  * 测试策略与质量保障：目标、范围、方法、覆盖率指标、维护与演进。

  * 可测性设计决策：时间与通知的抽象层、Core Data 运行模式（生产/测试）、分析SDK可拔插要求与移除流程。

  * 验收与发布清单：E1–E7 对应的验证步骤、边界用例、真机检查项。

  * 性能与隐私核查：冷启动路径、数据出站审查（确保零网络）、权限提示合规文案要点。

* PRD 补充说明：

  * E4 角标“点”的实现差异说明（iOS 仅数字徽章，采用 badge=1 近似）。

  * E7 分析仅启动事件的技术约束与移除计划（v1.0 物理移除）。

## 测试模块设计

* 新增 `MorningGoalTests` 单元测试目标，结构：

  * TestUtils：`InMemoryCoreData`、`DateProviderMock`、`NotificationCenterFake`。

  * LogicTests：`StreakServiceTests`、`DataControllerTests`、`NotificationServiceTests`、`AnalyticsTests`。

  * IntegrationLite：`GoalFlowTests`（以内存数据库验证今日输入→历史→Streak 的最小集成流）。

* 运行环境：

  * 使用 `NSPersistentContainer` 的内存存储类型（`NSInMemoryStoreType`）。

  * 对时间、通知、分析引入协议与可注入实现，测试中替换为 Mock/Fake。

## 可测性策略

* 时间抽象：

  * 引入 `DateProvider` 协议，生产使用 `SystemDateProvider`；测试使用固定日期的 `FixedDateProvider`。

  * 改造 `GoalEntry.todayString()` 与 `StreakService.count(...)` 支持注入 `Date` 与 `Calendar`。

* 通知抽象：

  * 引入 `NotificationScheduler` 协议，生产实现包装 `UNUserNotificationCenter` 与 `UIApplication`；测试使用 `NotificationCenterFake` 记录调用而不触发系统接口。

  * 可以使用脚本, 模拟模拟器接收到通知, 对应有没有跳转.

* Core Data 测试容器：

  * 提供 `makeInMemoryContainer()`，与生产模型一致但使用内存后端。

* 分析抽象：

  * 已有 `AnalyticsClient`，测试替换为 `CapturingAnalytics` 以断言仅在 Opt-In 时发送一次 `app_launch`。

## 关键用例与断言

* StreakServiceTests：

  * 连续 5 天记录→返回 5；中间断一天→截止到断点的计数；跨月跨年边界；空数据库返回 0。

  * 不同起始日期与 DST 切换日的稳健性（通过 `Calendar(identifier: .gregorian)` 与固定时区）。

* DataControllerTests：

  * 同日重复保存仅保留一条（唯一约束生效）；`NSMergeByPropertyObjectTrumpMergePolicy` 不抛异常。

  * `UserSettings.fetchOrCreate` 默认值正确（晨窗、Opt-In、committed）。

* NotificationServiceTests：

  * `scheduleDaily` 产生一个重复请求；`clearBadgeAndCancelToday` 清除徽章并移除对应标识请求。

  * 承诺后调度一次，保存当日目标后撤销当日 pending。

* AnalyticsTests：

  * Opt-In=false→不发送；Opt-In=true→活跃时发送一次且仅一次；移除实现时不影响其他逻辑。

* GoalFlowTests：

  * 引导设置→承诺→今日输入保存→Streak 与历史同步更新；再次保存不新增记录。

## 实施步骤

* 添加测试目标与文件结构：`MorningGoalTests/`。

* 引入测试工具类：创建内存 Core Data 容器与 Mock 实现。

* 小幅改造生产代码以注入依赖：

  * `StreakService.count(...)` 与 `GoalEntry.todayString(for:)` 支持传入日期与日历；默认保持现有 `Date()` 与 `Calendar.current`。

  * `NotificationService` 通过协议注入调度器；生产默认实例保持不变。

* 编写并运行单元测试，确保关键路径通过。

## 验收标准

* 单元测试覆盖核心逻辑模块（Streak、数据唯一性、通知、分析），核心用例全部通过。

* 测试可在无系统通知权限与网络的环境下稳定运行（Mock/Fake 覆盖）。

* 文档补充到位，与实现一致，能指导未来迭代与 v1.0 移除分析。

## 备选方案

* 若不改造生产代码：通过私有 API 包装与分类扩展进行最小侵入测试（可读性与长期维护较差）。

* 使用 SwiftData 替代 Core Data：不建议当前版本迁移，保持一致性与可靠性。

## 下一步

* 我将新增测试目标与文件，并按上述策略实现 Mock 与用例；同步补充技术文档的“测试策略与质量保障”章节。

